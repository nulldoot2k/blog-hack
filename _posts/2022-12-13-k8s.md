---
permalink: /k8s.html
---

<details>
<summary markdown=span style="font-size:24px"><b>Má»¥c Lá»¥c</b></summary>

Outline Training K8s - CKA

1. TÃ¬m hiá»ƒu vá» Docker. 

  > Docker lÃ  gÃ¬?

  > Kiáº¿n trÃºc cá»§a Docker - containerd  (container)

  > ğŸ’¨ [Docker](/docker.html)

2. TÃ¬m hiá»ƒu vá» K8s core **concert**

  > K8s lÃ  gÃ¬?

  > Setup k8s - Local (1 master + 1 worker - > 2GB RAM - >2CPU) - Virtualbox (Ubuntu). <br>
  - Kubeadm (sá»­ dá»¥ng).
  - Minukube
  - Rancher  
  - k3s

  > Kiáº¿n trÃºc cá»§a k8s
  - Etcd
  - Kube-API server
  - Kube Controller Manager
  - Kube Scheduler
  - Kubelet
  - Kube-proxy

  > kubectl
  
  > Namespaces

  > Pods

  > ReplicaSets
  
  > Deployments
  
  > Services
  - ClusterIP
  - NodePort
  - LoadBalancer

3. TÃ¬m hiá»ƒu vá» Scheduling

  > Labels vÃ  Pod Selectors
  
  > Taint and Tolerations
  
  > Node Selectors
  
  > Node Affinity
  
  > Resource and Limit
  
  > Static Pods
  
  > Multiple Scheduler

  > DaemonSets

4. TÃ¬m hiá»ƒu vá» Application Lifecycle Mangement

  > Rolling update

  > Rollback

  > Config Map

  > Secret

  > Multi Container

  > Init Container

5. Logging and Monitoring

  > Metric Server

  > Application Logs

6. Cluster Management

  > Upgrade

  > Backup and Restore

7. Security

  > Authentication

  > TLS 

  > Certificate API

  > KubeConfig

  > API Group

  > RBAC - Role + RoleBinding + ClusterRole + ClusterRoleBinding

  > ServiceAccount

  > Security Contexts

8. Network

  > DNS + CoreDNS

  > Cluster Networking

  > Pod Networking

  > CNI

  > Ingress + Ingress Controller

  > NetworkPolicy 

9. Storage

  > Container Storage Interface

  > Persistent Volumes

  > Persistent Volumes Claims

  > Storage Class

</details>

---

## K8s

Kubernetes lÃ  má»™t ná»n táº£ng nguá»“n má»Ÿ, cÃ³ thá»ƒ má»Ÿ rá»™ng Ä‘á»ƒ quáº£n lÃ½ cÃ¡c á»©ng dá»¥ng Ä‘Æ°á»£c Ä‘Ã³ng gÃ³i vÃ  cÃ¡c service, giÃºp thuáº­n lá»£i trong viá»‡c cáº¥u hÃ¬nh vÃ  tá»± Ä‘á»™ng hoÃ¡ viá»‡c triá»ƒn khai á»©ng dá»¥ng.

<p align=center>

![](https://0x0.st/o5zd.webp)
</p>

## ETCD

Etcd lÃ  má»™t thÃ nh pháº§n cá»§a K8s control plane.
Etcd má»™t há»‡ thá»‘ng phÃ¢n tÃ¡n, mÃ£ nguá»“n má»Ÿ, dÃ¹ng Ä‘á»ƒ lÆ°u trá»¯ cÃ¡c giÃ¡ trá»‹key-value.

<p align=center>

![](https://0x0.st/o5XO.png)
</p>

- Hiá»ƒu Ä‘Æ¡n giáº£n nháº¥t thÃ¬ Etcd chÃ­nh lÃ  1 database lÆ°u trá»¯ toÃ n bá»™ dá»¯ liá»‡u cá»§a k8s Cluster.

## Kube-API Server

Kube-API server lÃ  má»™t thÃ nh pháº§n cá»§a K8s control plane.

Kube-API server cung cáº¥p cÃ¡c API cho ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ tÆ°Æ¡ng tÃ¡c vá»›i cÃ¡c Ä‘á»‘i tÆ°á»£ng trong k8s nhÆ° pod, service, deployment, â€¦

- Hiá»ƒu Ä‘Æ¡n giáº£n nháº¥t thÃ¬ Kube-API server chÃ­nh lÃ  Lá»… TÃ¢n, nÆ¡i chÃºng ta cÃ³ thá»ƒ láº¥y hoáº·c yÃªu cáº§u thay Ä‘á»•i thÃ´ng tin.

## Kube-Controller-Manager
>
Kube-Controller-Manager lÃ  má»™t thÃ nh pháº§n cá»§a K8s control plane.<br>
Kube-Controller Ä‘iá»u khiá»ƒn, theo dÃµi má»i tráº¡ng thÃ¡i cá»§a k8s.<br>
Má»™t sá»‘ controller:<br>
  - Node Controller
  - Replication Controller
  - Endpoints Controller
  - Namespace Controller
  - â€¦

- Hiá»ƒu Ä‘Æ¡n giáº£n nháº¥t thÃ¬ Kube-Controller-Manager chÃ­nh lÃ  cÃ¡c Ã´ng sáº¿p quáº£n lÃ½ cÃ¡c hoáº¡t Ä‘á»™ng cá»§a con tÃ u.

## Kube-Scheduler

Kube-Scheduler lÃ  má»™t thÃ nh pháº§n cá»§a K8s control plane.

Nhiá»‡m vá»¥ chÃ­nh cá»§a Kube-Scheduler lÃ  lÃªn lá»‹ch trÃ¬nh cho cÃ¡c pod vÃ o cÃ¡c node tÆ°Æ¡ng á»©ng thÃ´ng qua nhiá»u cáº¥u hÃ¬nh khÃ¡c nhau.

- Hiá»ƒu Ä‘Æ¡n giáº£n nháº¥t thÃ¬ Kube-Scheduler chÃ­nh lÃ  máº¥y Ã´ng Ä‘iá»u phá»‘i viÃªn á»Ÿ Báº¿n TÃ u.

## Kubelet

Kubelet lÃ  má»™t thÃ nh pháº§n cá»§a K8s Node

Kubelet lÃ  má»™t agent Ä‘Æ°á»£c cháº¡y trÃªn cÃ¡c Node cá»§a K8s cluster, nÃ³ Ä‘áº£m báº£o ráº±ng cÃ¡c Container Ä‘Æ°á»£c cháº¡y trong cÃ¡c Pod.

- Hiá»ƒu Ä‘Æ¡n giáº£n thÃ¬ Kubelet chÃ­nh lÃ  cÃ¡c Ã´ng lÃ¡i tÃ u.

## Kube-proxy

Kube-proxy lÃ  má»™t thÃ nh pháº§n cá»§a K8s Node.

Kube-proxy lÃ  má»™t network proxy Ä‘Æ°á»£c cÃ i Ä‘áº·t trÃªn cÃ¡c Node, Ä‘áº£m báº£o cÃ¡c Pod cÃ³ thá»ƒ giao tiáº¿p vá»›i nhau.

- Hiá»ƒu Ä‘Æ¡n giáº£n thÃ¬ Kube-proxy chÃ­nh lÃ  nhá»¯ng LiÃªn láº¡c viÃªn trÃªn con tÃ u.

## Container Runtime

Container Runtime lÃ  má»™t thÃ nh pháº§n cá»§a K8s Node.

Container Runtime lÃ  má»™t pháº§n má»m chá»‹u trÃ¡ch nhiá»‡m cho viá»‡c cháº¡y cÃ¡c Container.

> Má»™t sá»‘ Container Runtime phá»• biáº¿n:
  - Docker
  - Containerd
  - CRI-O

- Hiá»ƒu Ä‘Æ¡n giáº£n thÃ¬ Container Runtime lÃ  loáº¡i tÃ u (thuyá»n, cano, â€¦)

## kubectl
- Kubectl lÃ  má»™t tool dÃ¹ng Ä‘á»ƒ giao tiáº¿p vá»›i K8s Cluster thÃ´ng qua Kube-API Server


## Nhá»¯ng mÃ´-Ä‘un Kubernetes cÆ¡ báº£n

<p align=center>

  ![](https://0x0.st/o58h.png)
</p>

### Táº¡o má»™t cluster

> Sá»­ dá»¥ng Minikube Ä‘á»ƒ táº¡o má»™t Cluster

Kubernetes Clusters: Kubernetes káº¿t ná»‘i vÃ  Ä‘iá»u phá»‘i cÃ¡c mÃ¡y tÃ­nh trong má»™t cluster Ä‘á»ƒ chÃºng cÃ³ thá»ƒ hoáº¡t Ä‘á»™ng nhÆ° má»™t Ä‘Æ¡n vá»‹ thá»‘ng nháº¥t (unit)

Má»™t Kubernetes cluster bao gá»“m 2 loáº¡i tÃ i nguyÃªn:

- Node Master lÃ m nhiá»‡m vá»¥ quáº£n lÃ½ toÃ n cluster.
- CÃ¡c Node cÃ²n láº¡i khá»Ÿi cháº¡y cÃ¡c á»©ng dá»¥ng trá»±c tiáº¿p trÃªn Ä‘Ã³ lÃ  cÃ¡c Worker.

<p align=center>

![](https://0x0.st/o5Ks.png)
</p>

- Node Master chá»‹u trÃ¡ch nhiá»‡m quáº£n lÃ½ Cluster
- Má»™t Node cÃ³ thá»ƒ lÃ  má»™t mÃ¡y áº£o (VM) hoáº·c má»™t mÃ¡y tÃ­nh váº­t lÃ½ lÃ m viá»‡c vá»›i vai trÃ² cung cáº¥p kháº£ nÄƒng tÃ­nh toÃ¡n cho cluster

- Cluster up and running

> minikube version : check version

> minikube start
  - BÃ¢y giá» báº¡n cÃ³ má»™t cá»¥m Kubernetes Ä‘ang cháº¡y trong thiáº¿t bá»‹ Ä‘áº§u cuá»‘i trá»±c tuyáº¿n cá»§a mÃ¬nh. Minikube Ä‘Ã£ khá»Ÿi Ä‘á»™ng má»™t mÃ¡y áº£o cho báº¡n vÃ  má»™t cá»¥m Kubernetes hiá»‡n Ä‘ang cháº¡y trong mÃ¡y áº£o Ä‘Ã³

- Cluster version

> kubectl version: kiá»ƒm tra xem cÃ i Ä‘áº·t chÆ°a

- xem chi tiáº¿t cá»¥m cluster

> kubectl cluster-info

- show node trong cluster

> kubectl get nodes


### Sá»­ dá»¥ng kubectl Ä‘á»ƒ triá»ƒn khai á»©ng dá»¥ng

Kubernetes Deployments

```plantext
Giáº£ sá»­ báº¡n Ä‘Ã£ cÃ³ má»™t Kubernetes cluster Ä‘ang hoáº¡t Ä‘á»™ng, báº¡n cÃ³ thá»ƒ triá»ƒn khai á»©ng dá»¥ng cá»§a báº¡n trÃªn cluster nÃ y.
Äá»ƒ thá»±c hiá»‡n Ä‘iá»u Ä‘Ã³, báº¡n cáº§n táº¡o má»™t ká»‹ch báº£n triá»ƒn khai (Deployment). Ká»‹ch báº£n nÃ y sáº½ giÃºp Kubernetes cÃ³ thá»ƒ táº¡o 
vÃ  cáº­p nháº­t cÃ¡c phiÃªn báº£n cháº¡y (instances) cá»§a á»©ng dá»¥ng cá»§a báº¡n. Sau khi má»™t ká»‹ch báº£n triá»ƒn khai Ä‘Æ°á»£c táº¡o ra 
trong Kubernetes, node Master sáº½ láº­p lá»‹ch Ä‘á»ƒ khá»Ÿi cháº¡y á»©ng dá»¥ng cá»§a báº¡n trÃªn cÃ¡c Node cá»§a cluster.

Sau khi á»©ng dá»¥ng cá»§a báº¡n Ä‘Æ°á»£c khá»Ÿi cháº¡y trÃªn cÃ¡c Node cá»§a cluster, Kubernetes sáº½ tiáº¿p tá»¥c theo dÃµi cÃ¡c chÆ°Æ¡ng 
trÃ¬nh Ä‘ang cháº¡y (instances) nÃ y. Náº¿u má»™t Node Ä‘ang cháº¡y má»™t instance cá»§a á»©ng dá»¥ng cá»§a báº¡n gáº·p trá»¥c tráº·c hoáº·c 
bá»‹ xÃ³a khá»i cluster, Kubernetes sáº½ thay tháº¿ instance Ä‘Ã³ báº±ng cÃ¡ch khá»Ÿi cháº¡y má»™t instance má»›i trÃªn má»™t Node khÃ¡c 
cá»§a cluster. ÄÃ¢y lÃ  cÆ¡ cháº¿ tá»± phá»¥c há»“i (self-healing) khi cÃ³ lá»—i xáº£y ra hoáº·c khi má»™t Node nÃ o Ä‘Ã³ cáº§n Ä‘Æ°á»£c 
báº£o trÃ¬.
```

<p align=center>

![](https://0x0.st/o5KK.png)
</p>

- Deploy our app

> kubectl create deployment kubernetes-bootcamp --image=gcr.io/google-samples/kubernetes-bootcamp:v1
  - kubernetes-bootcamp: name
  - --image: image docker hub

> Äá»ƒ liá»‡t kÃª cÃ¡c triá»ƒn khai cá»§a báº¡n, hÃ£y sá»­ dá»¥ng lá»‡nh nháº­n triá»ƒn khai

- kubectl get deployments
  - Tháº¥y ráº±ng cÃ³ 1 triá»ƒn khai Ä‘ang cháº¡y má»™t phiÃªn báº£n á»©ng dá»¥ng cá»§a báº¡n. PhiÃªn báº£n Ä‘ang cháº¡y bÃªn trong bá»™ chá»©a Docker trÃªn nÃºt cá»§a báº¡n

- View our app

> Pods Ä‘ang cháº¡y bÃªn trong Kubernetes Ä‘ang cháº¡y trÃªn má»™t máº¡ng riÃªng, biá»‡t láº­p. Theo máº·c Ä‘á»‹nh, chÃºng hiá»ƒn thá»‹ tá»« cÃ¡c pods vÃ  dá»‹ch vá»¥ khÃ¡c trong cÃ¹ng má»™t cá»¥m kubernetes, nhÆ°ng khÃ´ng hiá»ƒn thá»‹ bÃªn ngoÃ i máº¡ng Ä‘Ã³. Khi chÃºng ta sá»­ dá»¥ng kubectl, chÃºng ta Ä‘ang tÆ°Æ¡ng tÃ¡c thÃ´ng qua má»™t Ä‘iá»ƒm cuá»‘i API Ä‘á»ƒ giao tiáº¿p vá»›i á»©ng dá»¥ng cá»§a mÃ¬nh.<br>

> Lá»‡nh kubectl cÃ³ thá»ƒ táº¡o má»™t proxy sáº½ chuyá»ƒn tiáº¿p thÃ´ng tin liÃªn láº¡c vÃ o máº¡ng riÃªng, toÃ n cá»¥m. CÃ³ thá»ƒ káº¿t thÃºc proxy báº±ng cÃ¡ch nháº¥n control-C vÃ  sáº½ khÃ´ng hiá»ƒn thá»‹ báº¥t ká»³ Ä‘áº§u ra nÃ o khi Ä‘ang cháº¡y


### KhÃ¡m PhÃ¡ Pods VÃ  Nodes

- Kubernetes Pods: Má»™t Pod lÃ  má»™t khÃ¡i niá»‡m trá»«u tÆ°á»£ng cá»§a Kubernetes, Ä‘áº¡i diá»‡n cho má»™t nhÃ³m gá»“m má»™t hoáº·c nhiá»u á»©ng dá»¥ng containers (vÃ­ dá»¥ nhÆ° Docker hoáº·c rkt) vÃ  má»™t sá»‘ tÃ i nguyÃªn Ä‘Æ°á»£c chia sáº» cho cÃ¡c containers Ä‘Ã³. Nhá»¯ng tÃ i nguyÃªn Ä‘Ã³ bao gá»“m:

<p align=center>

![](https://0x0.st/o5PL.png)
</p>

> LÆ°u trá»¯ Ä‘Æ°á»£c chia sáº», dÆ°á»›i dáº¡ng Volumes

> Káº¿t ná»‘i máº¡ng, nhÆ° má»™t cluster IP duy nháº¥t

> ThÃ´ng tin vá» cÃ¡ch cháº¡y tá»«ng container, cháº³ng háº¡n nhÆ° phiÃªn báº£n container image hoáº·c cÃ¡c ports cá»¥ thá»ƒ Ä‘á»ƒ sá»­ dá»¥ng

> Má»™t Pod mÃ´ phá»ng má»™t "mÃ¡y chá»§ logic" dÃ nh riÃªng cho á»©ng dá»¥ng vÃ  cÃ³ thá»ƒ chá»©a cÃ¡c á»©ng dá»¥ng containers khÃ¡c nhau Ä‘Æ°á»£c liÃªn káº¿t tÆ°Æ¡ng Ä‘á»‘i cháº·t cháº½.

- Nodes

1. Má»™t Pod luÃ´n cháº¡y trÃªn má»™t Node
2. Má»™t Node lÃ  má»™t mÃ¡y worker trong Kubernetes vÃ  cÃ³ thá»ƒ lÃ  mÃ¡y áº£o hoáº·c mÃ¡y váº­t lÃ½, tuá»³ thuá»™c vÃ o cluster.
3. Má»—i Node Ä‘Æ°á»£c quáº£n lÃ­ bá»Ÿi Master.
4. Má»™t Node cÃ³ thá»ƒ chá»©a nhiá»u Pods vÃ  Kubernetes master tá»± Ä‘á»™ng xá»­ lÃ­ viá»‡c lÃªn lá»‹ch trÃ¬nh cÃ¡c Pods thuá»™c cÃ¡c Nodes á»Ÿ trong cluster.
5. Viá»‡c lÃªn lá»‹ch trÃ¬nh tá»± Ä‘á»™ng cá»§a Master sáº½ tÃ­nh Ä‘áº¿n cÃ¡c tÃ i nguyÃªn cÃ³ sáºµn trÃªn má»—i Node.

1. Má»—i Node á»Ÿ Kubernetes cháº¡y Ã­t nháº¥t:

> Kubelet, má»™t quy trÃ¬nh chá»‹u trÃ¡ch nhiá»‡m liÃªn láº¡c giá»¯a Kubernetes Master vÃ  Node; quáº£n lÃ­ cÃ¡c Pods vÃ  cÃ¡c containers Ä‘ang cháº¡y trÃªn cÃ¹ng má»™t mÃ¡y.

> Má»™t container runtime (nhÆ° Docker, rkt) chá»‹u trÃ¡ch nhiá»‡m láº¥y container image tá»« registry, giáº£i nÃ©n container vÃ  cháº¡y á»©ng dá»¥ng. CÃ¡c containers chá»‰ nÃªn Ä‘Æ°á»£c lÃªn lá»‹ch trÃ¬nh cÃ¹ng nhau trong má»™t Pod duy nháº¥t náº¿u chÃºng Ä‘Æ°á»£c liÃªn káº¿t cháº·t cháº½.

<p align=center>

![drawing](https://0x0.st/o5P4.png)
<style>
img[alt=drawing] { width: 300px; }
</style>
</p>

- CÃ¡c hoáº¡t Ä‘á»™ng phá»• biáº¿n nháº¥t cÃ³ thá»ƒ Ä‘Æ°á»£c thá»±c hiá»‡n vá»›i cÃ¡c lá»‡nh kubectl sau:

> kubectl get - liá»‡t kÃª cÃ¡c tÃ i nguyÃªn

> kubectl describe - hiá»ƒn thá»‹ thÃ´ng tin chi tiáº¿t vá» má»™t tÃ i nguyÃªn

> kubectl logs - in cÃ¡c báº£n ghi (logs) tá»« má»™t container trong má»™t pod

> kubectl exec - thá»±c hiá»‡n má»™t lá»‡nh trÃªn má»™t container trong má»™t pod

- Step 1 Check application configuration

lá»‡nh vÃ  tÃ¬m cÃ¡c Pod hiá»‡n cÃ³:

> kubectl get pods

Ä‘á»ƒ xem nhá»¯ng thÃ¹ng chá»©a nÃ o bÃªn trong Pod Ä‘Ã³ vÃ  nhá»¯ng hÃ¬nh áº£nh nÃ o Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ xÃ¢y dá»±ng nhá»¯ng thÃ¹ng chá»©a Ä‘Ã³

> kubectl describe pods

- Step 2 Hiá»ƒn thá»‹ á»©ng dá»¥ng trong thiáº¿t bá»‹ Ä‘áº§u cuá»‘i

> kubectl proxy

> curl http://localhost:8001/api/v1/namespaces/default/pods/$POD_NAME/proxy/

- Step 3 Xem nháº­t kÃ½ vÃ¹ng chá»©a

Má»i thá»© mÃ  á»©ng dá»¥ng thÆ°á»ng gá»­i tá»›i STDOUT sáº½ trá»Ÿ thÃ nh nháº­t kÃ½ cho vÃ¹ng chá»©a trong Pod. ChÃºng ta cÃ³ thá»ƒ truy xuáº¥t cÃ¡c nháº­t kÃ½ nÃ y báº±ng lá»‡nh kubectl logs:

> kubectl logs $POD_NAME
